library("tidyverse")
library("lingStuff")
library("here")


# 1. Load the data
titanic_raw <- read_csv(file=here("data", "titanic.csv"))

# 2. Get to know the data (how many columns? what do they represent?)
head(titanic_raw)
glimpse(titanic_raw)
summary(titanic_raw)

# 2a. Tidy data
titanic_tidy <- titanic_raw %>%
  mutate(
    Sex = as.factor(Sex), #converting sex, class into factors
    class = as.factor(Pclass)
  )
titanic_tidy
#transmute: mutates and keeps only what you mutate

# 2b. Plot
titanic_tidy %>%
  ggplot() +
  aes(x=Sex, y=Survived, color=class) +
  geom_jitter(height=0, width=0.3, alpha=0.1) + # geom_jitter disperses summary points over a bit so they're not all stacked on top of one another; keep height=0 here because we can them to stay either 0 or 1
  stat_summary(fun.data=mean_se,
               geom="pointrange",
               position = position_dodge(0.5)) #dodge moves summary points over a bit; this is okay for discrete vars like sex

titanic_tidy %>%
  ggplot() +
  aes(x=Age, y=Survived, color=Sex) +
  facet_grid(.~class) +
  geom_jitter(height=0, width=0.3, alpha=0.1) + # geom_jitter disperses summary points over a bit so they're not all stacked on top of one another; keep height=0 here because we can them to stay either 0 or 1
  geom_smooth(method="glm",
              method.args = list(family="binomial"))
  
# confirm with numbers
titanic_tidy %>%
  #group_by(Sex) %>%
  summarize(avg=mean(Survived))

# 3. Think of 2 hypotheses you could test
  #did survival rate depend on biological sex?
  # does class influence survival rate?

# 4. Fit the appropriate models to test your hypotheses
mod_0 <- glm(
  Survived ~ 1,
  data = titanic_tidy,
  family = binomial(link="logit") #if nothing here, then family=gaussian aka normal
  #binomial here is actually bernoulli
  )
#survived_i ~ bernoulli(1, p_i)
#logit(p_i) = a + bx + sex
summary(mod_0) #values are in log odds

mod_1 <- glm(
  Survived ~ 1 + Sex,
  data = titanic_tidy,
  family = binomial(link="logit") #if nothing here, then family=gaussian aka normal
  #binomial here is actually bernoulli
)
summary(mod_1)

#class models
mod_2 <- glm(
  Survived ~ 1 + class,
  data = titanic_tidy,
  family = binomial(link="logit") #if nothing here, then family=gaussian aka normal
  #binomial here is actually bernoulli
)
summary(mod_2)

mod_3 <- glm(
  Survived ~ 1 + class * Sex,
  data = titanic_tidy,
  family = binomial(link="logit") #if nothing here, then family=gaussian aka normal
  #binomial here is actually bernoulli
)
summary(mod_3)

# 5. Attempt to plot the data (include model fit)




# helpers
# method.args = list(family = "binomial")
# lingStuff::inv_logit()
# inv_logit_manual <- function(x){1 / (1 + exp(-x))}
# inv_logit_manual(coef(mod)[1] + coef(mod)[2] * mean(data$col))
